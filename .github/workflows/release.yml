name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
        env:
          VITE_TELEMETRY_DISABLED: '1'

      - name: Prepare release file
        run: |
          # 复制构建产物
          echo "📦 准备发布文件..."
          cp dist/index.html ./
          echo "✅ 准备完成: index.html"
          ls -lh index.html

      - name: Get or Create Tag
        id: get_tag
        run: |
          TAG_NAME="${{ github.ref_name || inputs.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            # 如果没有 tag，使用日期和时间生成
            TAG_NAME="v$(date +%Y%m%d-%H%M%S)"
            echo "创建新 tag: $TAG_NAME"
            git tag $TAG_NAME
            git push origin $TAG_NAME
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          body: |
            ## 🎉 礼簿系统 ${{ steps.get_tag.outputs.tag_name }} - 极致简化

            ### 🎯 本次核心改进

            **🔐 移除密码功能，让使用更简单！**
            - ✅ 数据本地存储，无需云端安全
            - ✅ 所有数据可随时导出Excel备份
            - ✅ 简化操作流程，提升用户体验
            - ✅ 无需记忆密码，直接使用

            **📊 移除导出全部功能，保持简洁！**
            - ✅ 只保留导出当前事件功能
            - ✅ 操作更专注，避免混淆
            - ✅ 每个事件独立管理，更清晰

            ### 🔧 技术变更

            **数据存储：**
            - 事件数据：`passwordHash` 字段保留但为空字符串
            - 礼金数据：明文JSON存储（原为加密字符串）
            - 会话管理：不再存储密码

            **功能简化：**
            - 创建事件：无需设置密码
            - 选择事件：直接进入，无需密码验证
            - 导入数据：无需密码检测重复
            - 导出数据：无需密码解密
            - 导出功能：移除"导出全部"，只保留"导出数据"

            **页面更新：**
            - `src/app/page.tsx`：移除密码输入界面，简化为事件选择
            - `src/app/setup/page.tsx`：移除密码输入框
            - `src/app/main/page.tsx`：移除密码验证逻辑，移除导出全部按钮
            - `src/store/appStore.ts`：移除密码状态管理
            - `src/lib/backup.ts`：移除密码参数、加密逻辑和exportAllExcel方法
            - `src/components/business/ImportExcelModal.tsx`：移除密码输入

            ### 💡 数据兼容性

            **旧数据迁移：**
            - ✅ 旧的加密数据仍然可以读取（store会自动解析）
            - ✅ 新数据以明文格式存储
            - ✅ 导出Excel功能不受影响

            **安全性说明：**
            - ⚠️ 数据存储在浏览器本地，可导出
            - ⚠️ 适合个人/小型活动使用
            - ⚠️ 如需更高安全性，建议使用专业财务软件

            ### 📦 历史功能回顾

            **v1.2.0 - 移除密码和导出全部**
            - ✅ 移除密码功能
            - ✅ 移除导出全部功能
            - ✅ 流程极致简化

            **v1.1.0 - Excel统一导入导出**
            - ✅ Excel导入导出统一方案
            - ✅ 智能预览和冲突检测
            - ✅ 支持多事件批量操作

            **v1.0.3 - 智能语音播报**
            - ✅ 自动语音播报确认
            - ✅ 操作语音反馈
            - ✅ 零依赖，浏览器原生支持

            **v1.0.0 - 基础功能**
            - ✅ 单文件应用，双击即用
            - ✅ 实时双屏同步
            - ✅ 打印/PDF 导出
            - ✅ 数据备份与恢复

            ### 🚀 快速开始

            1. 下载 `index.html`
            2. 双击打开
            3. 开始使用！

            ### 🎯 使用说明

            **数据管理：**
            - ✨ 创建新事件 或 📥 导入Excel数据
            - 📊 导出当前事件为Excel（礼金明细 + 统计汇总）
            - 🖥️ 开启副屏实时展示
            - 📄 打印/PDF 存档

            **数据安全：**
            - 所有数据存储在浏览器本地
            - 无需密码，直接使用
            - 定期导出Excel备份

            ### ⚠️ 重要提示

            - 数据仅存储在本地浏览器
            - 务必定期导出备份！
            - 清除浏览器数据会丢失记录

          files: index.html
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Success
        run: |
          echo "🎉 Release 发布成功!"
          echo "📦 Tag: ${{ steps.get_tag.outputs.tag_name }}"
          echo "🔗 下载地址: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag_name }}"
